import os
import logging
import sqlite3
import secrets
import string
from datetime import datetime

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, ContextTypes, filters
from telegram.error import BadRequest

# ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ====================
TOKEN = "8519774430:AAGHPewxXjkmj3fMmjjtMMlb3GD2oXGFR-0"
BOT_USERNAME = "Senderpfilesbot"

# ğŸ”¥ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ù†Ø§Ù„
FORCE_CHANNEL_ID = -1002034901903  # ID Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ù†Ø§Ù„
FORCE_CHANNEL_LINK = "https://t.me/betdesignernet/132"  # Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ú©Ø§Ù†Ø§Ù„
CHANNEL_USERNAME = "@betdesignernet"  # ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ú©Ø§Ù†Ø§Ù„

ADMIN_ID = 7321524568

# ==================== Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ====================
class Database:
    def __init__(self):
        self.conn = sqlite3.connect('bot.db', check_same_thread=False)
        self.init_db()
    
    def init_db(self):
        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS videos (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                unique_key TEXT UNIQUE,
                file_id TEXT,
                title TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                joined BOOLEAN DEFAULT FALSE,
                username TEXT,
                first_name TEXT,
                joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        self.conn.commit()
        logging.info("âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª")
    
    def add_video(self, unique_key, file_id, title=""):
        try:
            self.conn.execute('INSERT INTO videos (unique_key, file_id, title) VALUES (?, ?, ?)', 
                            (unique_key, file_id, title))
            self.conn.commit()
            logging.info(f"âœ… ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ú©Ø¯ {unique_key} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯")
            return True
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ¯ÛŒÙˆ: {e}")
            return False
    
    def get_video(self, unique_key):
        cursor = self.conn.execute('SELECT file_id, title FROM videos WHERE unique_key = ?', (unique_key,))
        result = cursor.fetchone()
        if result:
            return {'file_id': result[0], 'title': result[1]}
        return None
    
    def set_user_joined(self, user_id, username="", first_name=""):
        self.conn.execute(
            'INSERT OR REPLACE INTO users (user_id, joined, username, first_name) VALUES (?, ?, ?, ?)', 
            (user_id, True, username, first_name)
        )
        self.conn.commit()
        logging.info(f"âœ… Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¹Ø¶Ùˆ Ø«Ø¨Øª Ø´Ø¯")
    
    def has_user_joined(self, user_id):
        cursor = self.conn.execute('SELECT joined FROM users WHERE user_id = ?', (user_id,))
        result = cursor.fetchone()
        return result[0] if result else False

db = Database()

# ==================== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ====================
def generate_key():
    return 'vid_' + ''.join(secrets.choice(string.ascii_lowercase + string.digits) for _ in range(8))

def create_join_keyboard(video_key=None):
    """Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¹Ø¶ÙˆÛŒØª"""
    buttons = [
        [InlineKeyboardButton("ğŸ“¢ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„", url=FORCE_CHANNEL_LINK)],
        [InlineKeyboardButton("âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª", callback_data=f"check_{video_key}" if video_key else "check")]
    ]
    return InlineKeyboardMarkup(buttons)

def get_main_keyboard():
    """Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ØµÙ„ÛŒ"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø±", callback_data="stats")],
        [InlineKeyboardButton("â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§", callback_data="help")]
    ])

# ==================== Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª ====================
async def check_membership(user_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
    Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§ ID Ø¹Ø¯Ø¯ÛŒ
    """
    try:
        logging.info(f"ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ {FORCE_CHANNEL_ID}")
        
        member = await context.bot.get_chat_member(chat_id=FORCE_CHANNEL_ID, user_id=user_id)
        status = member.status
        
        logging.info(f"ğŸ‘¤ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± {user_id}: {status}")
        
        if status in ['member', 'administrator', 'creator']:
            logging.info(f"âœ… Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø§Ø³Øª")
            return True
        else:
            logging.warning(f"âŒ Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¹Ø¶Ùˆ Ù†ÛŒØ³Øª. ÙˆØ¶Ø¹ÛŒØª: {status}")
            return False
            
    except BadRequest as e:
        error_msg = str(e)
        logging.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª: {error_msg}")
        
        if "Chat not found" in error_msg:
            logging.error("âŒ Ú©Ø§Ù†Ø§Ù„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯:")
            logging.error(f"   1. ID Ú©Ø§Ù†Ø§Ù„ ØµØ­ÛŒØ­ Ø§Ø³Øª: {FORCE_CHANNEL_ID}")
            logging.error("   2. Ø±Ø¨Ø§Øª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª")
        elif "bot is not a member" in error_msg:
            logging.error("âŒ Ø±Ø¨Ø§Øª Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ù†ÛŒØ³Øª! Ø±Ø¨Ø§Øª Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯")
        
        return False
        
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª: {e}")
        return False

# ==================== Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ====================
async def send_video_to_user(context, user_id, video_key, message_to_edit=None):
    """
    Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ (ÙˆÛŒØ¯ÛŒÙˆ ÛŒØ§ document) Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    """
    try:
        video_data = db.get_video(video_key)
        if not video_data:
            error_text = "âŒ ÙØ§ÛŒÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."
            if message_to_edit:
                await message_to_edit.edit_text(error_text)
            else:
                await context.bot.send_message(user_id, error_text)
            return
        
        file_id = video_data['file_id']
        title = video_data['title'] or "ÙØ§ÛŒÙ„ Ø´Ù…Ø§"
        
        # ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…Ù†Ø§Ø³Ø¨
        try:
            # Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒÙ…
            await context.bot.send_video(
                user_id, 
                file_id, 
                caption=f"ğŸ¬ {title}\nğŸ”‘ Ú©Ø¯: {video_key}",
                reply_markup=get_main_keyboard()
            )
        except BadRequest:
            # Ø§Ú¯Ø± ÙˆÛŒØ¯ÛŒÙˆ Ù†Ø¨ÙˆØ¯ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… document Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒÙ…
            try:
                await context.bot.send_document(
                    user_id,
                    file_id,
                    caption=f"ğŸ“ {title}\nğŸ”‘ Ú©Ø¯: {video_key}",
                    reply_markup=get_main_keyboard()
                )
            except Exception as e:
                logging.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ document: {e}")
                raise
        
        if message_to_edit:
            await message_to_edit.edit_text("âœ… ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!")
        
        # Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¹Ø¶Ùˆ
        db.set_user_joined(user_id)
        logging.info(f"âœ… ÙØ§ÛŒÙ„ {video_key} Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")
        
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„: {e}")
        error_text = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."
        if message_to_edit:
            await message_to_edit.edit_text(error_text)
        else:
            await context.bot.send_message(user_id, error_text)

# ==================== Ù‡Ù†Ø¯Ù„Ø± Ø§Ø³ØªØ§Ø±Øª ====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    
    logging.info(f"ğŸš€ Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¯Ø³ØªÙˆØ± /start Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ø±Ø¯")
    
    # Ø§Ú¯Ø± Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† Ø¯Ø§Ø±Ø¯ (ÛŒØ¹Ù†ÛŒ Ø§Ø² Ù„ÛŒÙ†Ú© Ø¢Ù…Ø¯Ù‡)
    if context.args:
        start_arg = context.args[0]
        
        if start_arg.startswith("video_"):
            video_key = start_arg.replace("video_", "")
            logging.info(f"ğŸ¬ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ§ÛŒÙ„ {video_key} ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± {user_id}")
            
            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„
            if not db.get_video(video_key):
                await update.message.reply_text(
                    "âŒ Ù„ÛŒÙ†Ú© Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ ÙØ§ÛŒÙ„ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª.",
                    reply_markup=get_main_keyboard()
                )
                return
            
            # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡
            if db.has_user_joined(user_id):
                logging.info(f"âœ… Ú©Ø§Ø±Ø¨Ø± {user_id} Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡ØŒ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„")
                await send_video_to_user(context, user_id, video_key)
                return
            
            # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª ÙØ¹Ù„ÛŒ
            logging.info(f"ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± {user_id}")
            is_member = await check_membership(user_id, context)
            
            if is_member:
                logging.info(f"âœ… Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¹Ø¶Ùˆ Ø§Ø³ØªØŒ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„")
                db.set_user_joined(user_id, user.username, user.first_name)
                await send_video_to_user(context, user_id, video_key)
            else:
                logging.info(f"âš ï¸ Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¹Ø¶Ùˆ Ù†ÛŒØ³ØªØŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¹Ø¶ÙˆÛŒØª")
                await update.message.reply_text(
                    f"âš ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù…Ø§ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.\n\n"
                    f"ğŸ“¢ {CHANNEL_USERNAME}\n\n"
                    f"âœ… Ù¾Ø³ Ø§Ø² Ø¹Ø¶ÙˆÛŒØª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:",
                    reply_markup=create_join_keyboard(video_key)
                )
    else:
        # Ù¾ÛŒØ§Ù… Ø®ÙˆØ´Ø§Ù…Ø¯Ú¯ÙˆÛŒÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ
        await update.message.reply_text(
            f"Ø³Ù„Ø§Ù… {user.first_name}! ğŸ¤–\n\n"
            f"Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.\n\n"
            f"ğŸ¬ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ù…Ø®ØµÙˆØµ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.\n"
            f"ğŸ“¢ Ú©Ø§Ù†Ø§Ù„: {CHANNEL_USERNAME}\n\n"
            f"ğŸ” Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ù†Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
            reply_markup=get_main_keyboard()
        )

# ==================== Ù‡Ù†Ø¯Ù„Ø± Ø¯Ú©Ù…Ù‡ ====================
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    data = query.data
    
    logging.info(f"ğŸ”˜ Ø¯Ú©Ù…Ù‡ {data} ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± {user_id} ÙØ´Ø±Ø¯Ù‡ Ø´Ø¯")
    
    if data.startswith("check_"):
        video_key = data.replace("check_", "")
        
        logging.info(f"ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} (Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ú©Ù…Ù‡)")
        is_member = await check_membership(user_id, context)
        
        if is_member:
            db.set_user_joined(user_id)
            await send_video_to_user(context, user_id, video_key, query.message)
        else:
            await query.edit_message_text(
                "âŒ Ù‡Ù†ÙˆØ² Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¹Ø¶Ùˆ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯!\n\n"
                f"Ù„Ø·ÙØ§Ù‹:\n"
                f"1. Ø±ÙˆÛŒ 'Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯\n"
                f"2. Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ {CHANNEL_USERNAME} Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯\n" 
                f"3. Ø³Ù¾Ø³ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆÛŒ 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯\n\n"
                f"ğŸ” Ø§Ú¯Ø± Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ø§Ù…Ø§ Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ¯:\n"
                f"â€¢ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯\n"
                f"â€¢ Ø§Ø² Ú©Ø§Ù†Ø§Ù„ Ø®Ø§Ø±Ø¬ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯\n"
                f"â€¢ Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯",
                reply_markup=create_join_keyboard(video_key)
            )
    
    elif data == "stats":
        # Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø³Ø§Ø¯Ù‡
        await query.edit_message_text(
            f"ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª:\n\n"
            f"ğŸ¤– ÙˆØ¶Ø¹ÛŒØª: ÙØ¹Ø§Ù„\n"
            f"ğŸ”— Ú©Ø§Ù†Ø§Ù„: {CHANNEL_USERNAME}\n"
            f"ğŸ‘¤ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ø§Ø² Ù„ÛŒÙ†Ú© Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯",
            reply_markup=get_main_keyboard()
        )
    
    elif data == "help":
        await query.edit_message_text(
            "ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø¨Ø§Øª:\n\n"
            "ğŸ¬ Ø±ÙˆØ´ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„:\n"
            "1. Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ù…Ø®ØµÙˆØµ ÙØ§ÛŒÙ„ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯\n"
            "2. Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯\n"
            "3. Ø±ÙˆÛŒ 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯\n"
            "4. ÙØ§ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯\n\n"
            "âœ… Ù¾Ø³ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø¹Ø¶ÙˆÛŒØª:\n"
            "â€¢ Ø¯ÛŒÚ¯Ø± Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ù†ÛŒØ³Øª\n"
            "â€¢ ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯\n\n"
            f"ğŸ“¢ Ú©Ø§Ù†Ø§Ù„: {CHANNEL_USERNAME}",
            reply_markup=get_main_keyboard()
        )

# ==================== Ù‡Ù†Ø¯Ù„Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ====================
async def handle_channel_post(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ - Ù‡Ù… ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ù‡Ù… document
    """
    if not update.channel_post:
        return
    
    message = update.channel_post
    file_id = None
    file_type = None
    title = ""
    
    # ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„
    if message.video:
        file_id = message.video.file_id
        file_type = "video"
        title = message.caption or "ÙˆÛŒØ¯ÛŒÙˆ"
    elif message.document:
        file_id = message.document.file_id
        file_type = "document"
        title = message.caption or message.document.file_name or "ÙØ§ÛŒÙ„"
    else:
        return  # Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ù†Ø¨ÙˆØ¯ØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
    
    unique_key = generate_key()
    
    if db.add_video(unique_key, file_id, title):
        link = f"https://t.me/{BOT_USERNAME}?start=video_{unique_key}"
        
        try:
            await context.bot.send_message(
                ADMIN_ID,
                f"ğŸ“¦ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!\n\n"
                f"ğŸ“ Ù†ÙˆØ¹: {file_type}\n"
                f"ğŸ”‘ Ú©Ø¯: {unique_key}\n"
                f"ğŸ“ Ø¹Ù†ÙˆØ§Ù†: {title}\n"
                f"ğŸ”— Ù„ÛŒÙ†Ú©:\n{link}",
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("ğŸ“¬ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù„ÛŒÙ†Ú©", url=link)
                ]])
            )
            logging.info(f"âœ… ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ú©Ø¯ {unique_key} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯")
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")

# ==================== Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§Ø¯Ù…ÛŒÙ† ====================
async def test_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ØªØ³Øª Ø¹Ø¶ÙˆÛŒØª"""
    user_id = update.effective_user.id
    
    if user_id != ADMIN_ID:
        await update.message.reply_text("âŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.")
        return
    
    is_member = await check_membership(user_id, context)
    
    await update.message.reply_text(
        f"ğŸ” ØªØ³Øª Ø¹Ø¶ÙˆÛŒØª:\n\n"
        f"ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {user_id}\n"
        f"ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ID: {FORCE_CHANNEL_ID}\n"
        f"ğŸ”— Ù„ÛŒÙ†Ú©: {FORCE_CHANNEL_LINK}\n"
        f"âœ… Ø¹Ø¶Ùˆ Ø§Ø³Øª: {is_member}\n\n"
        f"ğŸ’¡ Ø§Ú¯Ø± 'Ø¹Ø¶Ùˆ Ø§Ø³Øª: False' ÙˆÙ„ÛŒ Ø´Ù…Ø§ Ø¹Ø¶Ùˆ Ù‡Ø³ØªÛŒØ¯:\n"
        f"â€¢ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø±Ø¨Ø§Øª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª\n"
        f"â€¢ ID Ú©Ø§Ù†Ø§Ù„ ØµØ­ÛŒØ­ Ø§Ø³Øª"
    )

async def add_file_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¯Ø³ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÛŒ ÙØ§ÛŒÙ„"""
    user_id = update.effective_user.id
    
    if user_id != ADMIN_ID:
        return
    
    if not (update.message.video or update.message.document):
        await update.message.reply_text("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙˆÛŒØ¯ÛŒÙˆ ÛŒØ§ ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")
        return
    
    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ù…Ø§Ù† Ù‡Ù†Ø¯Ù„Ø± Ú©Ø§Ù†Ø§Ù„
    await handle_channel_post(update, context)

# ==================== Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª ====================
def main():
    logging.basicConfig(
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        level=logging.INFO
    )
    
    logging.info("ğŸš€ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª...")
    logging.info(f"ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ID: {FORCE_CHANNEL_ID}")
    logging.info(f"ğŸ”— Ù„ÛŒÙ†Ú© Ú©Ø§Ù†Ø§Ù„: {FORCE_CHANNEL_LINK}")
    logging.info(f"ğŸ‘‘ Ø§Ø¯Ù…ÛŒÙ†: {ADMIN_ID}")
    
    app = Application.builder().token(TOKEN).build()
    
    # Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("test", test_cmd))
    app.add_handler(CommandHandler("add", add_file_cmd))
    app.add_handler(CallbackQueryHandler(button_handler))
    
    # Ù‡Ù†Ø¯Ù„Ø± Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ (Ù‡Ù… ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ù‡Ù… document)
    app.add_handler(MessageHandler(
        filters.ChatType.CHANNEL & (filters.VIDEO | filters.Document.ALL), 
        handle_channel_post
    ))
    
    logging.info("âœ… Ø±Ø¨Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª")
    app.run_polling(drop_pending_updates=True)

if __name__ == "__main__":
    main()
